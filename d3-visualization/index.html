<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç½‘è”æ±½è½¦æ•°æ®æº¯æºè¿½è¸ªç³»ç»Ÿ - å®æ—¶ç›‘æ§å¹³å°</title>
    <script src="assets/js/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
            color: white;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 1000;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            font-size: 14px;
            color: #8892b0;
            opacity: 0.8;
        }

        .controls {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .data-trace-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 20, 40, 0.9);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            min-width: 320px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .trace-title {
            font-size: 14px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 8px;
        }

        .data-packet-info {
            margin-bottom: 15px;
        }

        .packet-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .packet-label {
            color: #8892b0;
            font-weight: 500;
        }

        .packet-value {
            color: #00ff88;
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .vin-code {
            color: #fbbf24;
            font-weight: 700;
        }

        .credit-code {
            color: #ff6b35;
            font-weight: 700;
        }

        .trace-status {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 8px;
            margin-top: 10px;
        }

        .status-indicator-text {
            font-size: 10px;
            color: #00ff88;
            text-align: center;
        }

        .trace-progress {
            width: 100%;
            height: 4px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border-radius: 2px;
            width: 0%;
            transition: width 3s ease-in-out;
        }

        .progress-bar.active {
            width: 100%;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #00d4ff;
            border-radius: 20px;
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Icon size within buttons */
        .btn svg {
            width: 16px;
            height: 16px;
        }

        .btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }

        #visualization {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .node-group {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node-group:hover {
            filter: brightness(1.3);
        }

        .node-circle {
            filter: drop-shadow(0 0 8px currentColor);
            transition: all 0.3s ease;
        }

        .node-text {
            font-family: 'SF Pro Display', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        .node-label {
            font-family: 'SF Mono', monospace;
            font-size: 9px;
            text-anchor: middle;
            fill: #8892b0;
            pointer-events: none;
        }

        .node-status {
            font-size: 8px;
            text-anchor: middle;
            fill: #00ff88;
            pointer-events: none;
        }

        .link-path {
            fill: none;
            stroke-width: 2;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .link-path.straight {
            stroke-dasharray: none;
        }

        /* 2Dè§†å›¾åŠ¨ç”»ä¸äº¤äº’ï¼ˆæ¢å¤ï¼‰ */
        .link-path:hover {
            opacity: 1;
            stroke-width: 3;
        }

        .data-flow {
            stroke-dasharray: 8,4;
            animation: flowAnimation 2s linear infinite;
        }

        @keyframes flowAnimation {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -12; }
        }

        .highlight-path {
            stroke: #ff6b35;
            stroke-width: 3;
            opacity: 0.9;
            filter: drop-shadow(0 0 5px #ff6b35);
        }

        .pulse {
            animation: pulseAnimation 2s infinite;
        }

        @keyframes pulseAnimation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 2Dè§†å›¾æ‹–æ‹½æŒ‡é’ˆæç¤º */
        #visualization svg { cursor: grab; }
        #visualization svg:active { cursor: grabbing; }

        /* 3Dçƒä½“ä¸ä¸šåŠ¡èŠ‚ç‚¹æ ·å¼ï¼ˆæ¢å¤ï¼‰ */
        .sphere-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 600px;
            perspective: 1200px;
            z-index: 100;
            display: none;
        }

        .business-sphere {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(15deg) rotateY(0deg) rotateZ(0deg);
            transition: transform 0.3s ease;
            cursor: grab;
        }
        .business-sphere:active { cursor: grabbing; }
        .business-sphere.auto-rotate { animation: businessRotate 60s linear infinite; }
        @keyframes businessRotate {
            0% { transform: rotateX(15deg) rotateY(0deg) rotateZ(0deg); }
            100% { transform: rotateX(15deg) rotateY(360deg) rotateZ(0deg); }
        }

        .data-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            opacity: 0.9;
        }
        .sphere-layer-1 { transform: translateZ(250px) rotateX(0deg); }
        .sphere-layer-2 { transform: translateZ(150px) rotateX(20deg); }
        .sphere-layer-3 { transform: translateZ(0px) rotateX(0deg); }
        .sphere-layer-4 { transform: translateZ(-150px) rotateX(-20deg); }
        .sphere-layer-5 { transform: translateZ(-250px) rotateX(0deg); }

        .layer-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #00d4ff;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            z-index: 10;
        }

        .business-node {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00d4ff;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        .business-node:hover { transform: scale(1.2); box-shadow: 0 0 30px rgba(0, 212, 255, 0.6); border-color: #00ff88; }
        .node-icon { margin-bottom: 4px; }
.node-icon svg { width: 20px; height: 20px; display: block; }
        .node-label { font-size: 10px; color: white; text-align: center; font-weight: 500; }

        /* ä¸šåŠ¡èŠ‚ç‚¹é¢œè‰²ä¸»é¢˜ */
        .vehicle-node { border-color: #ff6b35; box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
        .sensor-node { border-color: #4f46e5; box-shadow: 0 0 20px rgba(79, 70, 229, 0.3); }
        .gateway-node { border-color: #059669; box-shadow: 0 0 20px rgba(5, 150, 105, 0.3); }
        .etl-node { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .storage-node { border-color: #dc2626; box-shadow: 0 0 20px rgba(220, 38, 38, 0.3); }
        .ai-node { border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .api-node { border-color: #8b5cf6; box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
        .blockchain-node { border-color: #7c3aed; box-shadow: 0 0 20px rgba(124, 58, 237, 0.3); }
        .enterprise-node { border-color: #06b6d4; box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }

        .sphere-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform-style: preserve-3d;
        }
        .connection-line-3d {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            transform-origin: left center;
            opacity: 0.8;
            animation: dataFlow3D 3s linear infinite;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        @keyframes dataFlow3D {
            0% { opacity: 0.3; box-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }
            50% { opacity: 1; box-shadow: 0 0 15px rgba(0, 212, 255, 0.8); }
            100% { opacity: 0.3; box-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }
        }
        .sphere-ring {
            position: absolute;
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 50%;
            animation: ringPulse 4s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3), inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        @keyframes ringPulse {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1) rotateX(0deg);
                border-color: rgba(0, 212, 255, 0.4);
            }
            25% {
                opacity: 0.8;
                transform: scale(1.05) rotateX(90deg);
                border-color: rgba(0, 255, 136, 0.6);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1) rotateX(180deg);
                border-color: rgba(255, 107, 53, 0.5);
            }
            75% {
                opacity: 0.9;
                transform: scale(1.05) rotateX(270deg);
                border-color: rgba(124, 58, 237, 0.6);
            }
        }

        .data-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: particleFloat 6s ease-in-out infinite;
        }

        .particle-type-1 {
            background: #00ff88;
            box-shadow: 0 0 12px #00ff88, 0 0 24px rgba(0, 255, 136, 0.3);
        }

        .particle-type-2 {
            background: #00d4ff;
            box-shadow: 0 0 12px #00d4ff, 0 0 24px rgba(0, 212, 255, 0.3);
        }

        .particle-type-3 {
            background: #ff6b35;
            box-shadow: 0 0 12px #ff6b35, 0 0 24px rgba(255, 107, 53, 0.3);
        }

        .particle-type-4 {
            background: #7c3aed;
            box-shadow: 0 0 12px #7c3aed, 0 0 24px rgba(124, 58, 237, 0.3);
        }

        @keyframes particleFloat {
            0% {
                transform: translateZ(0px) translateX(0px) translateY(0px);
                opacity: 1;
            }
            25% {
                transform: translateZ(80px) translateX(20px) translateY(-20px);
                opacity: 0.8;
            }
            50% {
                transform: translateZ(120px) translateX(-15px) translateY(25px);
                opacity: 0.4;
            }
            75% {
                transform: translateZ(80px) translateX(-25px) translateY(-10px);
                opacity: 0.7;
            }
            100% {
                transform: translateZ(0px) translateX(0px) translateY(0px);
                opacity: 1;
            }
        }

        .metrics-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            backdrop-filter: blur(10px);
        }

        .metrics-title {
            font-size: 14px;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 10px;
            text-align: center;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .metric-label {
            color: #8892b0;
        }

        .metric-value {
            color: #00ff88;
            font-weight: 600;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 20, 40, 0.95);
            color: #00d4ff;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2000;
            border: 1px solid #00d4ff;
            backdrop-filter: blur(10px);
        }

        .connection-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            opacity: 0.6;
            animation: connectionPulse 3s ease-in-out infinite;
        }

        @keyframes connectionPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #00ff88;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: statusBlink 2s infinite;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* æ—¶é—´è½´æº¯æºè¿½è¸ªæ ·å¼ */
        .trace-timeline {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 380px;
            max-height: 350px;
            background: rgba(0, 20, 40, 0.95);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .timeline-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            background: rgba(0, 212, 255, 0.1);
        }

        .timeline-header h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #00d4ff;
            text-align: center;
        }

        .timeline-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 10px;
            color: #8892b0;
        }

        .timeline-steps {
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            opacity: 0.3;
            transition: all 0.5s ease;
            position: relative;
        }

        .timeline-step.active {
            opacity: 1;
            animation: stepHighlight 0.8s ease-in-out;
        }

        @keyframes stepHighlight {
            0% { transform: translateX(-10px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .timeline-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: -15px;
            width: 2px;
            background: linear-gradient(to bottom, #00d4ff, rgba(0, 212, 255, 0.3));
        }

        .step-marker {
            min-width: 30px;
            height: 30px;
            background: #00d4ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #0a0a0a;
            margin-right: 12px;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 12px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 4px;
        }

        .step-time {
            font-size: 10px;
            color: #fbbf24;
            font-family: 'SF Mono', monospace;
            margin-bottom: 4px;
        }

        .step-details {
            font-size: 10px;
            color: #8892b0;
            line-height: 1.4;
        }

        /* 2DèŠ‚ç‚¹å’Œé“¾æ¥é«˜äº®æ ·å¼ */
        .node-group.trace-active .node-circle {
            stroke: #ff6b35;
            stroke-width: 4;
            filter: drop-shadow(0 0 15px #ff6b35);
            animation: nodeTraceGlow 1.5s ease-in-out infinite alternate;
        }

        @keyframes nodeTraceGlow {
            0% { 
                stroke-width: 4;
                filter: drop-shadow(0 0 15px #ff6b35);
            }
            100% { 
                stroke-width: 6;
                filter: drop-shadow(0 0 25px #ff6b35);
            }
        }

        .link-path.trace-active {
            stroke: #ff6b35;
            stroke-width: 4;
            opacity: 1;
            filter: drop-shadow(0 0 8px #ff6b35);
            animation: linkTraceFlow 2s linear infinite;
        }

        @keyframes linkTraceFlow {
            0% { 
                stroke-dasharray: 10,5;
                stroke-dashoffset: 0; 
            }
            100% { 
                stroke-dasharray: 10,5;
                stroke-dashoffset: -15; 
            }
        }

        /* å¢å¼ºçš„æ•°æ®åŒ…å·¥å…·æç¤º */
        .packet-tooltip {
            background: rgba(0, 20, 40, 0.98);
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 12px;
            font-size: 11px;
            color: #00ff88;
            min-width: 200px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .packet-tooltip .tooltip-header {
            font-weight: bold;
            color: #00d4ff;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 4px;
            margin-bottom: 6px;
        }

        .packet-tooltip .tooltip-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .packet-tooltip .tooltip-label {
            color: #8892b0;
        }

        .packet-tooltip .tooltip-value {
            color: #00ff88;
            font-weight: 600;
        }

        /* 3Dä¸šåŠ¡èŠ‚ç‚¹å’Œè¿çº¿é«˜äº®æ ·å¼ */
        .business-node.trace-active {
            border-color: #ff6b35;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.8);
            animation: businessNodePulse 1.5s ease-in-out infinite;
            transform: scale(1.2);
        }

        @keyframes businessNodePulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(255, 107, 53, 0.8);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 107, 53, 1), 0 0 60px rgba(255, 107, 53, 0.5);
            }
        }

        .connection-line-3d.trace-active {
            background: linear-gradient(90deg, transparent, #ff6b35, transparent);
            box-shadow: 0 0 15px #ff6b35, 0 0 30px rgba(255, 107, 53, 0.5);
            animation: connection3DTrace 1.5s linear infinite;
            height: 4px;
        }

        @keyframes connection3DTrace {
            0% { 
                opacity: 0.6;
                box-shadow: 0 0 15px #ff6b35;
            }
            50% { 
                opacity: 1;
                box-shadow: 0 0 25px #ff6b35, 0 0 40px rgba(255, 107, 53, 0.7);
            }
            100% { 
                opacity: 0.6;
                box-shadow: 0 0 15px #ff6b35;
            }
        }
    </style>
</head>
<body>
    <!-- SVG å›¾æ ‡ç²¾çµ -->
    <svg style="display: none;">
        <defs>
            <!-- å¼€å§‹æº¯æºå›¾æ ‡ -->
            <symbol id="icon-play" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" fill="currentColor"/>
            </symbol>
            
            <!-- é«˜äº®è·¯å¾„å›¾æ ‡ -->
            <symbol id="icon-highlight" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
            </symbol>
            
            <!-- 3Dè§†å›¾å›¾æ ‡ -->
            <symbol id="icon-3d" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- 2Dè§†å›¾å›¾æ ‡ -->
            <symbol id="icon-2d" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- æ–°æ•°æ®åŒ…å›¾æ ‡ -->
            <symbol id="icon-refresh" viewBox="0 0 24 24">
                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- è½¦è½½ç»ˆç«¯å›¾æ ‡ -->
            <symbol id="icon-vehicle" viewBox="0 0 24 24">
                <path d="M5 11L6.5 6.5h11L19 11m-5 5h1.5a2 2 0 002-2v-2H6.5v2a2 2 0 002 2H10" stroke="currentColor" stroke-width="2" fill="none"/>
                <circle cx="8.5" cy="15.5" r="2.5" fill="currentColor"/>
                <circle cx="15.5" cy="15.5" r="2.5" fill="currentColor"/>
            </symbol>
            
            <!-- ä¼ æ„Ÿå™¨å›¾æ ‡ -->
            <symbol id="icon-sensor" viewBox="0 0 24 24">
                <path d="M12 2L8 7h8l-4-5zm0 20l4-5H8l4 5zm6-10L7 8v8l11-4zm-6-4v8m-4-4h8" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- ç½‘å…³å›¾æ ‡ -->
            <symbol id="icon-gateway" viewBox="0 0 24 24">
                <path d="M2 3h20v18H2V3zm2 2v14h16V5H4zm4 2h8v2H8V7zm0 4h8v2H8v-2zm0 4h8v2H8v-2z" fill="currentColor"/>
            </symbol>
            
            <!-- ETLå¤„ç†å›¾æ ‡ -->
            <symbol id="icon-etl" viewBox="0 0 24 24">
                <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2zm0-10h18v2H3V4z" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M9 8l3 3-3 3m6-6l-3 3 3 3" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- æ•°æ®æ¹–å›¾æ ‡ -->
            <symbol id="icon-storage" viewBox="0 0 24 24">
                <path d="M3 9v10a2 2 0 002 2h14a2 2 0 002-2V9M3 9V7a2 2 0 012-2h14a2 2 0 012 2v2M3 9l9 5 9-5" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- AIåˆ†æå›¾æ ‡ -->
            <symbol id="icon-ai" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M12 1v6m0 10v6m11-7h-6m-10 0H1m15.5-8.5l-4.24 4.24M8.5 8.5L4.26 4.26m12.48 15.48l-4.24-4.24M8.5 15.5l-4.24 4.24" stroke="currentColor" stroke-width="2"/>
            </symbol>
            
            <!-- APIæœåŠ¡å›¾æ ‡ -->
            <symbol id="icon-api" viewBox="0 0 24 24">
                <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- åŒºå—é“¾å›¾æ ‡ -->
            <symbol id="icon-blockchain" viewBox="0 0 24 24">
                <rect x="2" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="9" y="9" width="6" height="6" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="16" y="16" width="6" height="6" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M8 5h1m6 3h1m-9 6v1m3 3h1" stroke="currentColor" stroke-width="2"/>
            </symbol>
            
            <!-- ä¼ä¸šå¹³å°å›¾æ ‡ -->
            <symbol id="icon-enterprise" viewBox="0 0 24 24">
                <path d="M3 21h18M3 10h18M5 6l7-3 7 3v15H5V6z" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M9 9v3m3-3v3m3-3v3" stroke="currentColor" stroke-width="2"/>
            </symbol>
            
            <!-- ç›‘æ§å›¾æ ‡ -->
            <symbol id="icon-monitor" viewBox="0 0 24 24">
                <rect x="2" y="4" width="20" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M8 20h8m-4-4v4" stroke="currentColor" stroke-width="2"/>
                <path d="M6 8l4 4 2-2 4 4" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
        </defs>
    </svg>

    <div class="container">
        <div class="header">
            <h1 class="title">æ™ºèƒ½ç½‘è”æ±½è½¦æ•°æ®æº¯æºè¿½è¸ªç³»ç»Ÿ</h1>
            <p class="subtitle">Vehicle Data Lineage & Traceability Platform</p>
        </div>

        <div class="data-trace-panel">
            <div class="trace-title">ğŸ“¦ æ•°æ®åŒ…æº¯æºè¿½è¸ª</div>
            <div class="data-packet-info">
                <div class="packet-item">
                    <span class="packet-label">æ•°æ®åŒ…ID:</span>
                    <span class="packet-value" id="packetId">PKT-20241212-001847</span>
                </div>
                <div class="packet-item">
                    <span class="packet-label">è½¦è¾†VINç :</span>
                    <span class="packet-value vin-code" id="vinCode">LSGWB54E8KS123456</span>
                </div>
                <div class="packet-item">
                    <span class="packet-label">ä¼ä¸šä¿¡ç”¨ä»£ç :</span>
                    <span class="packet-value credit-code" id="creditCode">91110000MA01234567</span>
                </div>
                <div class="packet-item">
                    <span class="packet-label">æ•°æ®ç±»å‹:</span>
                    <span class="packet-value" id="dataType">ä½ç½®è½¨è¿¹+é©¾é©¶è¡Œä¸º</span>
                </div>
                <div class="packet-item">
                    <span class="packet-label">é‡‡é›†æ—¶é—´:</span>
                    <span class="packet-value" id="collectTime">2024-12-12 14:18:47</span>
                </div>
                <div class="packet-item">
                    <span class="packet-label">æ•°æ®å¤§å°:</span>
                    <span class="packet-value" id="dataSize">2.34 MB</span>
                </div>
            </div>
            <div class="trace-status">
                <div class="status-indicator-text" id="traceStatus">æ­£åœ¨è¿½è¸ªæ•°æ®æµå‘...</div>
                <div class="trace-progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="startDataTrace()">
                <svg aria-hidden="true"><use href="#icon-play"></use></svg>
                <span>å¼€å§‹æº¯æº</span>
            </button>
            <button class="btn" onclick="highlightTraceability()">
                <svg aria-hidden="true"><use href="#icon-highlight"></use></svg>
                <span>é«˜äº®è·¯å¾„</span>
            </button>
            <button class="btn" onclick="toggle3DView()" id="toggle3DButton">
                <svg aria-hidden="true"><use href="#icon-3d"></use></svg>
                <span>3Dè§†å›¾</span>
            </button>
            <button class="btn" onclick="generateNewPacket()">
                <svg aria-hidden="true"><use href="#icon-refresh"></use></svg>
                <span>æ–°æ•°æ®åŒ…</span>
            </button>
        </div>

        <div class="status-indicator">
            <div class="status-dot"></div>
            <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
        </div>

        <div id="visualization">
            <!-- 3Dä¸šåŠ¡æ•°æ®æº¯æºçƒä½“ -->
            <div class="sphere-container" id="sphereContainer">
                <div class="business-sphere" id="businessSphere">
                    <!-- æ•°æ®æºå±‚ (æœ€å¤–å±‚) -->
                    <div class="data-layer sphere-layer-1" id="sourceLayer">
                        <div class="layer-title">æ•°æ®æºå±‚</div>
                        <div class="business-node vehicle-node" data-business="è½¦è½½ç»ˆç«¯" data-node-id="vehicle" style="left: 200px; top: 150px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-vehicle"></use></svg></div>
                            <div class="node-label">è½¦è½½ç»ˆç«¯</div>
                        </div>
                        <div class="business-node sensor-node" data-business="ä¼ æ„Ÿå™¨" data-node-id="sensor" style="left: 500px; top: 200px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-sensor"></use></svg></div>
                            <div class="node-label">ä¼ æ„Ÿå™¨</div>
                        </div>
                    </div>

                    <!-- é‡‡é›†å¤„ç†å±‚ -->
                    <div class="data-layer sphere-layer-2" id="processLayer">
                        <div class="layer-title">é‡‡é›†å¤„ç†å±‚</div>
                        <div class="business-node gateway-node" data-business="æ•°æ®ç½‘å…³" data-node-id="gateway" style="left: 150px; top: 250px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-gateway"></use></svg></div>
                            <div class="node-label">æ•°æ®ç½‘å…³</div>
                        </div>
                        <div class="business-node etl-node" data-business="ETLå¤„ç†" data-node-id="etl" style="left: 550px; top: 180px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-etl"></use></svg></div>
                            <div class="node-label">ETLå¤„ç†</div>
                        </div>
                    </div>

                    <!-- å­˜å‚¨åˆ†æå±‚ (ä¸­å¿ƒå±‚) -->
                    <div class="data-layer sphere-layer-3" id="storageLayer">
                        <div class="layer-title">å­˜å‚¨åˆ†æå±‚</div>
                        <div class="business-node storage-node" data-business="æ•°æ®æ¹–" data-node-id="storage" style="left: 300px; top: 300px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-storage"></use></svg></div>
                            <div class="node-label">æ•°æ®æ¹–</div>
                        </div>
                        <div class="business-node ai-node" data-business="AIåˆ†æ" data-node-id="ai" style="left: 450px; top: 150px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-ai"></use></svg></div>
                            <div class="node-label">AIåˆ†æ</div>
                        </div>
                    </div>

                    <!-- åº”ç”¨æœåŠ¡å±‚ -->
                    <div class="data-layer sphere-layer-4" id="serviceLayer">
                        <div class="layer-title">åº”ç”¨æœåŠ¡å±‚</div>
                        <div class="business-node api-node" data-business="APIæœåŠ¡" data-node-id="api" style="left: 250px; top: 350px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-api"></use></svg></div>
                            <div class="node-label">APIæœåŠ¡</div>
                        </div>
                        <div class="business-node blockchain-node" data-business="åŒºå—é“¾" data-node-id="blockchain" style="left: 500px; top: 300px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-blockchain"></use></svg></div>
                            <div class="node-label">åŒºå—é“¾</div>
                        </div>
                    </div>

                    <!-- ä¸šåŠ¡åº”ç”¨å±‚ (æœ€å†…å±‚) -->
                    <div class="data-layer sphere-layer-5" id="applicationLayer">
                        <div class="layer-title">ä¸šåŠ¡åº”ç”¨å±‚</div>
                        <div class="business-node enterprise-node" data-business="ä¼ä¸šå¹³å°" data-node-id="enterprise" style="left: 375px; top: 275px;">
                            <div class="node-icon"><svg aria-hidden="true"><use href="#icon-enterprise"></use></svg></div>
                            <div class="node-label">ä¼ä¸šå¹³å°</div>
                        </div>
                    </div>

                    <!-- 3Dè¿çº¿å®¹å™¨ -->
                    <div class="sphere-connections" id="sphereConnections"></div>
                </div>
            </div>
        </div>

        <div class="metrics-panel">
            <div class="metrics-title"><svg aria-hidden="true"><use href="#icon-monitor"></use></svg><span style="margin-left:8px;">å®æ—¶ç›‘æ§</span></div>
            <div class="metric-item">
                <span class="metric-label">æ•°æ®åå:</span>
                <span class="metric-value" id="throughput">2.3 GB/s</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">å“åº”å»¶è¿Ÿ:</span>
                <span class="metric-value" id="latency">8ms</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">æˆåŠŸç‡:</span>
                <span class="metric-value" id="successRate">99.97%</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">æ´»è·ƒèŠ‚ç‚¹:</span>
                <span class="metric-value" id="activeNodes">11</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">æº¯æºæ·±åº¦:</span>
                <span class="metric-value" id="traceDepth">5å±‚</span>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // æ•°æ®å®šä¹‰
        const nodes = [
            { id: 'edge', name: 'Edge IoT', label: 'è½¦è½½ä¼ æ„Ÿå™¨', x: 200, y: 300, color: '#ff6b35', size: 30, status: 'active', angle: 0 },
            { id: 'cloud', name: 'Cloud Storage', label: 'åˆ†å¸ƒå¼å­˜å‚¨', x: 350, y: 200, color: '#4f46e5', size: 35, status: 'active', angle: 45 },
            { id: 'backup', name: 'Backup', label: 'å¤‡ä»½å­˜å‚¨', x: 350, y: 400, color: '#6366f1', size: 25, status: 'normal', angle: 90 },
            { id: 'ml', name: 'ML Model', label: 'æ¨¡å‹è®­ç»ƒ', x: 500, y: 150, color: '#059669', size: 28, status: 'normal', angle: 135 },
            { id: 'ai', name: 'AI Engine', label: 'æ·±åº¦å­¦ä¹ å¤„ç†', x: 600, y: 300, color: '#10b981', size: 40, status: 'selected', gpu: '87%', angle: 180 },
            { id: 'feature', name: 'Feature', label: 'ç‰¹å¾å·¥ç¨‹', x: 500, y: 450, color: '#34d399', size: 25, status: 'normal', angle: 225 },
            { id: 'gateway', name: 'Gateway', label: 'APIç½‘å…³', x: 750, y: 200, color: '#dc2626', size: 22, status: 'normal', angle: 270 },
            { id: 'api', name: 'Secure API', label: 'åŠ å¯†ä¼ è¾“', x: 850, y: 300, color: '#ef4444', size: 32, status: 'active', security: 'TLS 1.3', angle: 315 },
            { id: 'monitor', name: 'Monitor', label: 'ç›‘æ§ä¸­å¿ƒ', x: 750, y: 400, color: '#f87171', size: 20, status: 'normal', angle: 360 },
            { id: 'blockchain', name: 'Blockchain', label: 'å­˜è¯é“¾', x: 1000, y: 350, color: '#7c3aed', size: 30, status: 'active', block: '#1247', angle: 45 },
            { id: 'enterprise', name: 'Enterprise', label: 'ä¼ä¸šæ¥æ”¶æ–¹', x: 1150, y: 300, color: '#8b5cf6', size: 35, status: 'online', angle: 90 }
        ];

        const links = [
            { source: 'edge', target: 'cloud', type: 'main', strength: 0.8 },
            { source: 'edge', target: 'backup', type: 'backup', strength: 0.3 },
            { source: 'cloud', target: 'ai', type: 'main', strength: 0.9 },
            { source: 'cloud', target: 'ml', type: 'normal', strength: 0.5 },
            { source: 'backup', target: 'feature', type: 'normal', strength: 0.4 },
            { source: 'ai', target: 'api', type: 'main', strength: 0.9 },
            { source: 'ai', target: 'gateway', type: 'normal', strength: 0.6 },
            { source: 'feature', target: 'monitor', type: 'normal', strength: 0.4 },
            { source: 'api', target: 'enterprise', type: 'main', strength: 0.8 },
            { source: 'api', target: 'blockchain', type: 'security', strength: 0.7 },
            { source: 'blockchain', target: 'enterprise', type: 'main', strength: 0.8 }
        ];

        // åˆ›å»ºSVG
        const width = window.innerWidth;
        const height = window.innerHeight;
        const svg = d3.select('#visualization')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .style('position', 'absolute')
            .style('top', 0)
            .style('left', 0);

        // æ·»åŠ æ‹–æ‹½å’Œç¼©æ”¾åŠŸèƒ½
        const zoom = d3.zoom()
            .scaleExtent([0.5, 3])
            .on('zoom', function(event) {
                const { transform } = event;
                nodeGroup.attr('transform', transform);
                linkGroup.attr('transform', transform);
            });

        svg.call(zoom);

        // åˆ›å»ºæ¸å˜å’Œæ»¤é•œ
        const defs = svg.append('defs');

        // å‘å…‰æ»¤é•œ
        const glowFilter = defs.append('filter')
            .attr('id', 'glow')
            .attr('x', '-50%')
            .attr('y', '-50%')
            .attr('width', '200%')
            .attr('height', '200%');

        glowFilter.append('feGaussianBlur')
            .attr('stdDeviation', '4')
            .attr('result', 'coloredBlur');

        const feMerge = glowFilter.append('feMerge');
        feMerge.append('feMergeNode').attr('in', 'coloredBlur');
        feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

        // ç®­å¤´æ ‡è®°
        const arrowMarker = defs.append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 8)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto');

        arrowMarker.append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#00d4ff');

        // åˆ›å»ºè¿çº¿ç»„
        const linkGroup = svg.append('g').attr('class', 'links');
        const nodeGroup = svg.append('g').attr('class', 'nodes');

        // ç»˜åˆ¶è¿çº¿
        const linkElements = linkGroup.selectAll('.link-path')
            .data(links)
            .enter()
            .append('line')
            .attr('class', 'link-path straight')
            .attr('stroke', d => {
                switch(d.type) {
                    case 'main': return '#00d4ff';
                    case 'security': return '#ff6b35';
                    case 'backup': return '#6366f1';
                    default: return '#8892b0';
                }
            })
            .attr('stroke-width', d => 2 + d.strength * 2)
            .attr('marker-end', 'url(#arrowhead)')
            .attr('x1', d => {
                const source = nodes.find(n => n.id === d.source);
                return source.x;
            })
            .attr('y1', d => {
                const source = nodes.find(n => n.id === d.source);
                return source.y;
            })
            .attr('x2', d => {
                const target = nodes.find(n => n.id === d.target);
                return target.x;
            })
            .attr('y2', d => {
                const target = nodes.find(n => n.id === d.target);
                return target.y;
            });

        // ç»˜åˆ¶èŠ‚ç‚¹
        const nodeElements = nodeGroup.selectAll('.node-group')
            .data(nodes)
            .enter()
            .append('g')
            .attr('class', 'node-group')
            .attr('transform', d => `translate(${d.x}, ${d.y})`);

        // èŠ‚ç‚¹å¤–åœˆï¼ˆé€‰ä¸­çŠ¶æ€ï¼‰
        nodeElements.filter(d => d.status === 'selected')
            .append('circle')
            .attr('r', d => d.size + 8)
            .attr('fill', 'none')
            .attr('stroke', '#fbbf24')
            .attr('stroke-width', 2)
            .attr('class', 'pulse');

        // èŠ‚ç‚¹ä¸»ä½“
        nodeElements.append('circle')
            .attr('class', 'node-circle')
            .attr('r', d => d.size)
            .attr('fill', d => d.color)
            .attr('filter', 'url(#glow)')
            .style('color', d => d.color);

        // èŠ‚ç‚¹æ–‡å­—
        nodeElements.append('text')
            .attr('class', 'node-text')
            .attr('y', 0)
            .text(d => d.name);

        // èŠ‚ç‚¹æ ‡ç­¾
        nodeElements.append('text')
            .attr('class', 'node-label')
            .attr('y', d => d.size + 18)
            .text(d => d.label);

        // çŠ¶æ€æŒ‡ç¤ºå™¨
        nodeElements.filter(d => d.gpu)
            .append('text')
            .attr('class', 'node-status')
            .attr('y', d => -d.size - 8)
            .text(d => `GPU: ${d.gpu}`);

        nodeElements.filter(d => d.security)
            .append('text')
            .attr('class', 'node-status')
            .attr('y', d => -d.size - 8)
            .text(d => d.security);

        nodeElements.filter(d => d.block)
            .append('text')
            .attr('class', 'node-status')
            .attr('y', d => -d.size - 8)
            .text(d => `Block ${d.block}`);

        // æ´»è·ƒçŠ¶æ€æŒ‡ç¤ºç‚¹
        nodeElements.filter(d => d.status === 'active' || d.status === 'online')
            .append('circle')
            .attr('cx', d => d.size - 8)
            .attr('cy', d => -d.size + 8)
            .attr('r', 4)
            .attr('fill', '#00ff88')
            .attr('class', 'pulse');

        // å·¥å…·æç¤º
        const tooltip = d3.select('#tooltip');

        nodeElements
            .on('mouseover', function(event, d) {
                tooltip
                    .style('opacity', 1)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px')
                    .html(`
                        <strong>${d.name}</strong><br/>
                        ç±»å‹: ${d.label}<br/>
                        çŠ¶æ€: ${d.status}<br/>
                        ${d.gpu ? `GPUåˆ©ç”¨ç‡: ${d.gpu}<br/>` : ''}
                        ${d.security ? `å®‰å…¨åè®®: ${d.security}<br/>` : ''}
                        ${d.block ? `åŒºå—é«˜åº¦: ${d.block}<br/>` : ''}
                    `);
            })
            .on('mouseout', function() {
                tooltip.style('opacity', 0);
            });

        // æ·»åŠ æ•°æ®ç²’å­åˆ°3Dçƒä½“
        function addDataParticles() {
            const sphereContainer = document.getElementById('sphereConnections'); // ä¿®å¤ID
            const particleTypes = ['particle-type-1', 'particle-type-2', 'particle-type-3', 'particle-type-4'];

            for (let i = 0; i < 40; i++) {
                const particle = document.createElement('div');
                const typeClass = particleTypes[Math.floor(Math.random() * particleTypes.length)];
                particle.className = `data-particle ${typeClass}`;

                // åœ¨çƒä½“èŒƒå›´å†…éšæœºåˆ†å¸ƒ
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 120 + 20;
                const x = Math.cos(angle) * radius + 150;
                const y = Math.sin(angle) * radius + 150;

                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (4 + Math.random() * 4) + 's';

                if (sphereContainer) sphereContainer.appendChild(particle); // å®¹é”™å¤„ç†
            }

            // æ·»åŠ ä¸­å¿ƒæ ¸å¿ƒç²’å­
            const coreParticle = document.createElement('div');
            coreParticle.className = 'data-particle particle-type-2';
            coreParticle.style.left = '147px';
            coreParticle.style.top = '147px';
            coreParticle.style.width = '12px';
            coreParticle.style.height = '12px';
            coreParticle.style.animationDuration = '3s';
            coreParticle.style.zIndex = '200';
            if (sphereContainer) sphereContainer.appendChild(coreParticle);
        }

        // åŠŸèƒ½å‡½æ•°
        let animationActive = false;

        function startDataFlow() {
            if (animationActive) return;
            animationActive = true;

            linkElements
                .filter(d => d.type === 'main')
                .classed('data-flow', true);

            setTimeout(() => {
                linkElements.classed('data-flow', false);
                animationActive = false;
            }, 5000);
        }

        function startDataTrace() {
            // é‡ç½®è¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.remove('active');
            
            // æ–°å¢ï¼šå¼€å§‹æ•°æ®æº¯æºæ¼”ç¤º
            // ç”Ÿæˆæ–°çš„æ•°æ®åŒ…æ•°æ®
            const newPacketData = generateRandomPacketData();
            
            // æ›´æ–°æ—¶ç©ºæº¯æºè¿½è¸ªæ•°æ®
            Object.assign(currentPacketData, newPacketData);
            currentPacketData.traceSequence = [
                { step: 1, timestamp: new Date(Date.now() + 0).toISOString().slice(0, -1), node: 'edge', action: 'æ•°æ®é‡‡é›†', location: 'è½¦è½½ç»ˆç«¯', details: 'é‡‡é›†GPSä½ç½®ã€é€Ÿåº¦ã€æ–¹å‘è§’ç­‰è½¦è¾†çŠ¶æ€ä¿¡æ¯' },
                { step: 2, timestamp: new Date(Date.now() + 1000).toISOString().slice(0, -1), node: 'cloud', action: 'æ•°æ®ä¼ è¾“', location: 'æ•°æ®ç½‘å…³', details: 'é€šè¿‡4G/5Gç½‘ç»œä¸Šä¼ ï¼ŒTLSåŠ å¯†ä¼ è¾“' },
                { step: 3, timestamp: new Date(Date.now() + 2000).toISOString().slice(0, -1), node: 'ai', action: 'æ•°æ®å¤„ç†', location: 'AIåˆ†æå¼•æ“', details: 'æ•°æ®æ¸…æ´—ã€æ ¼å¼è½¬æ¢ã€å¼‚å¸¸æ£€æµ‹' },
                { step: 4, timestamp: new Date(Date.now() + 3000).toISOString().slice(0, -1), node: 'backup', action: 'æ•°æ®å­˜å‚¨', location: 'åˆ†å¸ƒå¼å­˜å‚¨', details: 'å»ºç«‹ç´¢å¼•å…³ç³»ï¼Œå¤šå‰¯æœ¬å¤‡ä»½' },
                { step: 5, timestamp: new Date(Date.now() + 4000).toISOString().slice(0, -1), node: 'api', action: 'æœåŠ¡å°è£…', location: 'APIæœåŠ¡', details: 'ç”Ÿæˆæ ‡å‡†åŒ–RESTful APIæ¥å£' },
                { step: 6, timestamp: new Date(Date.now() + 5000).toISOString().slice(0, -1), node: 'blockchain', action: 'å­˜è¯ä¸Šé“¾', location: 'åŒºå—é“¾ç½‘ç»œ', details: 'æ•°æ®å“ˆå¸Œå­˜è¯ï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹æ€§' },
                { step: 7, timestamp: new Date(Date.now() + 6000).toISOString().slice(0, -1), node: 'enterprise', action: 'æ•°æ®äº¤ä»˜', location: 'ä¼ä¸šç›‘ç®¡å¹³å°', details: 'æ¨é€è‡³ä¼ä¸šæ•°æ®æ²»ç†å¹³å°' }
            ];
            
            // æ›´æ–°æ•°æ®åŒ…æ˜¾ç¤ºä¿¡æ¯
            updatePacketDisplay(currentPacketData);
            
            // æ˜¾ç¤ºæ—¶é—´è½´
            showTraceTimeline(currentPacketData);
            
            // å¯åŠ¨è¿›åº¦æ¡ä¸€æ¬¡æ€§åŠ¨ç”»
            setTimeout(() => {
                progressBar.classList.add('active');
            }, 100);
            
            // å¯åŠ¨èŠ‚ç‚¹å’Œé“¾æ¥åˆ†æ­¥é«˜äº®ï¼ˆç§»é™¤3Dæ¨¡å¼ï¼‰
            startStepByStepTrace();
        }

        function generateNewPacket() {
            // æ–°å¢ï¼šç”Ÿæˆæ–°æ•°æ®åŒ…æ¼”ç¤º
            if (is3DView) {
                render3DLinksFrom2D();
            } else {
                // 2Dæ¨¡å¼ä¸‹æ¸…é™¤ç°æœ‰åŠ¨ç”»ï¼Œé‡æ–°å¼€å§‹
                linkElements.classed('data-flow highlight-path', false);
                setTimeout(() => startDataFlow(), 200);
            }
        }

        function highlightTraceability() {
            const mainPath = links.filter(d => d.type === 'main');
            linkElements
                .filter(d => d.type === 'main')
                .classed('highlight-path', true);

            setTimeout(() => {
                linkElements.classed('highlight-path', false);
            }, 4000);
        }

        // 2Dæ¨¡å¼åˆ†æ­¥é«˜äº®è¿½è¸ª
        function startStepByStepTrace() {
            // æ¸…é™¤ç°æœ‰é«˜äº®
            nodeElements.classed('trace-active', false);
            linkElements.classed('trace-active', false);
            
            currentPacketData.traceSequence.forEach((step, index) => {
                setTimeout(() => {
                    // é«˜äº®å½“å‰èŠ‚ç‚¹
                    nodeElements
                        .filter(d => d.id === step.node)
                        .classed('trace-active', true);
                    
                    // é«˜äº®åˆ°è¾¾è¯¥èŠ‚ç‚¹çš„é“¾æ¥
                    if (index > 0) {
                        const prevStep = currentPacketData.traceSequence[index - 1];
                        linkElements
                            .filter(d => d.source === prevStep.node && d.target === step.node)
                            .classed('trace-active', true);
                    }
                    
                    // æ›´æ–°æº¯æºçŠ¶æ€
                    document.getElementById('traceStatus').textContent = 
                        `Step ${step.step}: ${step.action} - ${step.location}`;
                        
                }, index * 800);
            });
            
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            setTimeout(() => {
                nodeElements.classed('trace-active', false);
                linkElements.classed('trace-active', false);
                document.getElementById('traceStatus').textContent = 'æ•°æ®æº¯æºè¿½è¸ªå®Œæˆ';
            }, currentPacketData.traceSequence.length * 800 + 2000);
        }

        // 3Dæ¨¡å¼å¢å¼ºä¸šåŠ¡èŠ‚ç‚¹è¿½è¸ªåŠ¨ç”»
        function startBusinessTraceAnimationWithHighlight() {
            const connectionsContainer = document.getElementById('sphereConnections');
            
            // æ¸…é™¤ç°æœ‰é«˜äº®å’Œè¿çº¿
            document.querySelectorAll('.business-node').forEach(node => {
                node.classList.remove('trace-active');
            });
            document.querySelectorAll('.connection-line-3d').forEach(conn => {
                conn.remove();
            });
            
            // 3DèŠ‚ç‚¹æ˜ å°„
            const nodeMapping = {
                edge: 'vehicle',
                cloud: 'gateway', 
                ai: 'ai',
                backup: 'storage',
                api: 'api',
                blockchain: 'blockchain',
                enterprise: 'enterprise'
            };
            
            currentPacketData.traceSequence.forEach((step, index) => {
                setTimeout(() => {
                    const nodeId = nodeMapping[step.node];
                    if (nodeId) {
                        // é«˜äº®3Dä¸šåŠ¡èŠ‚ç‚¹
                        const businessNode = document.querySelector(`[data-node-id="${nodeId}"]`);
                        if (businessNode) {
                            businessNode.classList.add('trace-active');
                        }
                        
                        // åˆ›å»ºè¿çº¿åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                        if (index < currentPacketData.traceSequence.length - 1) {
                            const nextStep = currentPacketData.traceSequence[index + 1];
                            const nextNodeId = nodeMapping[nextStep.node];
                            if (nextNodeId) {
                                setTimeout(() => {
                                    const connection = create3DConnection(nodeId, nextNodeId, '#ff6b35');
                                    if (connection) {
                                        connection.classList.add('trace-active');
                                    }
                                }, 400);
                            }
                        }
                    }
                    
                    // æ›´æ–°æº¯æºçŠ¶æ€
                    document.getElementById('traceStatus').textContent = 
                        `Step ${step.step}: ${step.action} - ${step.location}`;
                        
                }, index * 1000);
            });
            
            // æ¸…é™¤é«˜äº®
            setTimeout(() => {
                document.querySelectorAll('.business-node').forEach(node => {
                    node.classList.remove('trace-active');
                });
                document.querySelectorAll('.connection-line-3d').forEach(conn => {
                    conn.classList.remove('trace-active');
                });
                document.getElementById('traceStatus').textContent = '3Dæ•°æ®æº¯æºè¿½è¸ªå®Œæˆ';
            }, currentPacketData.traceSequence.length * 1000 + 3000);
        }

        let is3DView = false;
        let sphereRotation = { x: 15, y: 0, z: 0 };
        let isDraggingSphere = false;
        let lastMouse = { x: 0, y: 0 };

        function applySphereRotation() {
            const el = document.getElementById('businessSphere');
            if (!el) return;
            el.style.transform = `rotateX(${sphereRotation.x}deg) rotateY(${sphereRotation.y}deg) rotateZ(${sphereRotation.z}deg)`;
        }

        function setupSphereInteractions() {
            const sphere = document.getElementById('businessSphere');
            if (!sphere || sphere.__interactionBound) return;

            sphere.addEventListener('mousedown', (e) => {
                isDraggingSphere = true;
                lastMouse.x = e.clientX;
                lastMouse.y = e.clientY;
            });
            window.addEventListener('mousemove', (e) => {
                if (!isDraggingSphere) return;
                const dx = e.clientX - lastMouse.x;
                const dy = e.clientY - lastMouse.y;
                lastMouse.x = e.clientX;
                lastMouse.y = e.clientY;
                sphereRotation.y += dx * 0.3;
                sphereRotation.x -= dy * 0.3;
                applySphereRotation();
            });
            window.addEventListener('mouseup', () => {
                isDraggingSphere = false;
            });

            // æ–°å¢ï¼šç§»åŠ¨ç«¯è§¦æ§æ‹–æ‹½æ”¯æŒ
            sphere.addEventListener('touchstart', (e) => {
                if (!e.touches || e.touches.length === 0) return;
                const t = e.touches[0];
                isDraggingSphere = true;
                lastMouse.x = t.clientX;
                lastMouse.y = t.clientY;
            }, { passive: true });
            window.addEventListener('touchmove', (e) => {
                if (!isDraggingSphere || !e.touches || e.touches.length === 0) return;
                const t = e.touches[0];
                const dx = t.clientX - lastMouse.x;
                const dy = t.clientY - lastMouse.y;
                lastMouse.x = t.clientX;
                lastMouse.y = t.clientY;
                sphereRotation.y += dx * 0.3;
                sphereRotation.x -= dy * 0.3;
                applySphereRotation();
            }, { passive: true });
            window.addEventListener('touchend', () => {
                isDraggingSphere = false;
            }, { passive: true });

            // é˜»æ­¢æ–‡æœ¬é€‰ä¸­å½±å“æ‹–æ‹½ä½“éªŒ
            sphere.addEventListener('dragstart', e => e.preventDefault());
            sphere.__interactionBound = true;
        }

        function render3DLinksFrom2D() {
            // ä½¿ç”¨ä¸2Dç›¸åŒçš„æ•°æ®ï¼šlinksä¸­source/targetæ˜ å°„åˆ°3Dä¸šåŠ¡èŠ‚ç‚¹id
            const map2DTo3D = {
                edge: 'vehicle',
                cloud: 'etl', // è¿‘ä¼¼æ˜ å°„ï¼šäº‘å­˜å‚¨->ETLå¤„ç†
                backup: 'storage',
                ml: 'ai',
                ai: 'ai',
                feature: 'storage',
                gateway: 'api',
                api: 'api',
                monitor: 'enterprise', // è¿‘ä¼¼æ˜ å°„
                blockchain: 'blockchain',
                enterprise: 'enterprise'
            };
            const connectionsContainer = document.getElementById('sphereConnections');
            if (!connectionsContainer) return;
            
            // æ¸…ç†ç°æœ‰è¿çº¿ï¼Œä½†ä¿ç•™ç²’å­
            const existingConnections = connectionsContainer.querySelectorAll('.connection-line-3d');
            existingConnections.forEach(conn => conn.remove());

            links.forEach(l => {
                const from = map2DTo3D[l.source];
                const to = map2DTo3D[l.target];
                if (!from || !to) return;
                const color = (l.type === 'main') ? '#00d4ff' : (l.type === 'security' ? '#ff6b35' : '#8892b0');
                create3DConnection(from, to, color);
            });
        }

        function toggle3DView() {
            const sphereContainer = document.getElementById('sphereContainer');
            const svgVisualization = svg.node();

            if (!is3DView) {
                // åˆ‡æ¢åˆ°3Dä¸šåŠ¡è§†å›¾
                sphereContainer.style.display = 'block';
                svgVisualization.style.display = 'none';
                is3DView = true;

                // åœæ­¢è‡ªåŠ¨æ—‹è½¬ï¼Œå¯ç”¨äº¤äº’æ‹–æ‹½
                const bs = document.getElementById('businessSphere');
                bs.classList.remove('auto-rotate');
                setupSphereInteractions();
                applySphereRotation();

                // è®©3Dè¿çº¿ä¸2Dæ•°æ®ä¸€è‡´
                render3DLinksFrom2D();

                // æ›´æ–°æŒ‰é’®å›¾æ ‡ä¸æ–‡å­—
                const btn = document.getElementById('toggle3DButton');
                const btnIcon = btn.querySelector('use');
                const btnText = btn.querySelector('span');
                if (btnIcon) btnIcon.setAttribute('href', '#icon-2d');
                if (btnText) btnText.textContent = '2Dè§†å›¾';
            } else {
                // åˆ‡æ¢å›2Dç½‘ç»œè§†å›¾
                sphereContainer.style.display = 'none';
                svgVisualization.style.display = 'block';
                is3DView = false;

                // æ¸…ç†3Dè¿çº¿
                const connectionsContainer = document.getElementById('sphereConnections');
                if (connectionsContainer) {
                    const existingConnections = connectionsContainer.querySelectorAll('.connection-line-3d');
                    existingConnections.forEach(conn => conn.remove());
                }

                // æ›´æ–°æŒ‰é’®å›¾æ ‡ä¸æ–‡å­—
                const btn = document.getElementById('toggle3DButton');
                const btnIcon = btn.querySelector('use');
                const btnText = btn.querySelector('span');
                if (btnIcon) btnIcon.setAttribute('href', '#icon-3d');
                if (btnText) btnText.textContent = '3Dè§†å›¾';
            }
        }

        function startBusinessTraceAnimation() {
            const connectionsContainer = document.getElementById('sphereConnections');

            // ä»…æ¸…é™¤ç°æœ‰3Dè¿çº¿ï¼Œä¿ç•™ç²’å­
            const existingConnections = connectionsContainer.querySelectorAll('.connection-line-3d');
            existingConnections.forEach(conn => conn.remove());

            // å®šä¹‰3Dä¸šåŠ¡æ•°æ®æµè¿æ¥
            const businessConnections = [
                { from: 'vehicle', to: 'gateway', color: '#ff6b35', delay: 0 },
                { from: 'sensor', to: 'etl', color: '#4f46e5', delay: 500 },
                { from: 'gateway', to: 'storage', color: '#059669', delay: 1000 },
                { from: 'etl', to: 'ai', color: '#10b981', delay: 1500 },
                { from: 'storage', to: 'api', color: '#dc2626', delay: 2000 },
                { from: 'ai', to: 'blockchain', color: '#fbbf24', delay: 2500 },
                { from: 'api', to: 'enterprise', color: '#8b5cf6', delay: 3000 },
                { from: 'blockchain', to: 'enterprise', color: '#7c3aed', delay: 3500 }
            ];

            // åˆ›å»º3Dè¿çº¿
            businessConnections.forEach((connection, index) => {
                setTimeout(() => {
                    create3DConnection(connection.from, connection.to, connection.color);
                }, connection.delay);
            });
        }

        function create3DConnection(fromNodeId, toNodeId, color) {
            const fromNode = document.querySelector(`[data-node-id="${fromNodeId}"]`);
            const toNode = document.querySelector(`[data-node-id="${toNodeId}"]`);

            if (!fromNode || !toNode) return;

            // è·å–èŠ‚ç‚¹ä½ç½®
            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const containerRect = document.getElementById('sphereConnections').getBoundingClientRect();

            const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
            const fromY = fromRect.top - containerRect.top + fromRect.height / 2;
            const toX = toRect.left - containerRect.left + toRect.width / 2;
            const toY = toRect.top - containerRect.top + toRect.height / 2;

            // è®¡ç®—è¿çº¿é•¿åº¦å’Œè§’åº¦
            const dx = toX - fromX;
            const dy = toY - fromY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            // åˆ›å»ºè¿çº¿å…ƒç´ 
            const connectionLine = document.createElement('div');
            connectionLine.className = 'connection-line-3d';
            connectionLine.style.left = fromX + 'px';
            connectionLine.style.top = fromY + 'px';
            connectionLine.style.width = length + 'px';
            connectionLine.style.transform = `rotate(${angle}deg)`;
            connectionLine.style.background = `linear-gradient(90deg, transparent, ${color}, transparent)`;
            connectionLine.style.boxShadow = `0 0 10px ${color}`;
            connectionLine.style.animationDelay = Math.random() * 2 + 's';

            document.getElementById('sphereConnections').appendChild(connectionLine);
            return connectionLine;
        }

        function resetView() {
            linkElements
                .classed('highlight-path', false)
                .classed('data-flow', false);
            animationActive = false;
        }

        // å®æ—¶æ›´æ–°æŒ‡æ ‡
        function updateMetrics() {
            document.getElementById('throughput').textContent = (2.1 + Math.random() * 0.4).toFixed(1) + ' GB/s';
            document.getElementById('latency').textContent = Math.floor(6 + Math.random() * 4) + 'ms';
            document.getElementById('successRate').textContent = (99.95 + Math.random() * 0.04).toFixed(2) + '%';
            document.getElementById('traceDepth').textContent = Math.floor(4 + Math.random() * 3) + 'å±‚';
        }

        // ä¸šåŠ¡èŠ‚ç‚¹äº¤äº’
        function initBusinessNodeInteractions() {
            const businessNodes = document.querySelectorAll('.business-node');
            const tooltip = document.getElementById('tooltip');

            businessNodes.forEach(node => {
                node.addEventListener('mouseenter', function(e) {
                    const business = this.getAttribute('data-business');
                    const layer = this.closest('.data-layer').querySelector('.layer-title').textContent;

                    tooltip.style.opacity = '1';
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 10) + 'px';
                    tooltip.innerHTML = `
                        <strong>${business}</strong><br/>
                        æ‰€å±å±‚çº§: ${layer}<br/>
                        çŠ¶æ€: è¿è¡Œä¸­<br/>
                        æ•°æ®æµé‡: ${(Math.random() * 100).toFixed(1)} MB/s<br/>
                        å¤„ç†å»¶è¿Ÿ: ${Math.floor(Math.random() * 50 + 10)}ms
                    `;
                });

                node.addEventListener('mouseleave', function() {
                    tooltip.style.opacity = '0';
                });

                node.addEventListener('click', function() {
                    // é«˜äº®è¯¥èŠ‚ç‚¹ç›¸å…³çš„æ•°æ®æµè·¯å¾„
                    const business = this.getAttribute('data-business');
                    highlightBusinessPath(business);
                });
            });
        }

        function highlightBusinessPath(businessType) {
            // æ ¹æ®ä¸šåŠ¡ç±»å‹é«˜äº®ç›¸å…³è·¯å¾„
            const paths = document.querySelectorAll('.trace-path');
            paths.forEach(path => {
                path.style.opacity = '0.3';
            });

            // è¿™é‡Œå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘æ¥é«˜äº®ç‰¹å®šè·¯å¾„
            setTimeout(() => {
                paths.forEach(path => {
                    path.style.opacity = '0.7';
                });
            }, 2000);
        }

        // åˆå§‹åŒ–
        addDataParticles();
        initBusinessNodeInteractions();
        setInterval(updateMetrics, 2000);

        // è‡ªåŠ¨å¯åŠ¨æ¼”ç¤º
        setTimeout(() => {
            startDataFlow();
        }, 1500);
        // æ•°æ®åŒ…æ—¶ç©ºæº¯æºè¿½è¸ªæ•°æ®ç»“æ„
        const currentPacketData = {
            id: 'PKT-20241212-001847',
            vin: 'LSGWB54E8KS123456',
            creditCode: '91110000MA01234567',
            dataType: 'ä½ç½®è½¨è¿¹+é©¾é©¶è¡Œä¸º',
            collectTime: '2024-12-12 14:18:47',
            dataSize: '2.34 MB',
            vehicleModel: 'ç†æƒ³L9',
            manufacturer: 'åŒ—äº¬ç†æƒ³æ±½è½¦æœ‰é™å…¬å¸',
            location: { lat: 39.9042, lng: 116.4074, address: 'åŒ—äº¬å¸‚æœé˜³åŒº' },
            traceSequence: [
                { step: 1, timestamp: '2024-12-12 14:18:47.123', node: 'vehicle', action: 'æ•°æ®é‡‡é›†', location: 'è½¦è½½ç»ˆç«¯', details: 'é‡‡é›†GPSä½ç½®ã€é€Ÿåº¦ã€æ–¹å‘è§’' },
                { step: 2, timestamp: '2024-12-12 14:18:47.456', node: 'gateway', action: 'æ•°æ®ä¼ è¾“', location: 'æ•°æ®ç½‘å…³', details: 'é€šè¿‡4G/5Gç½‘ç»œä¸Šä¼ ï¼ŒåŠ å¯†ä¼ è¾“' },
                { step: 3, timestamp: '2024-12-12 14:18:47.789', node: 'etl', action: 'æ•°æ®å¤„ç†', location: 'ETLå¤„ç†', details: 'æ•°æ®æ¸…æ´—ã€æ ¼å¼è½¬æ¢ã€è´¨é‡æ£€æŸ¥' },
                { step: 4, timestamp: '2024-12-12 14:18:48.012', node: 'storage', action: 'æ•°æ®å­˜å‚¨', location: 'æ•°æ®æ¹–', details: 'åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå»ºç«‹ç´¢å¼•å…³ç³»' },
                { step: 5, timestamp: '2024-12-12 14:18:48.345', node: 'ai', action: 'AIåˆ†æ', location: 'AIåˆ†æå¼•æ“', details: 'è½¨è¿¹å¼‚å¸¸æ£€æµ‹ã€è¡Œä¸ºæ¨¡å¼åˆ†æ' },
                { step: 6, timestamp: '2024-12-12 14:18:48.678', node: 'api', action: 'æœåŠ¡å°è£…', location: 'APIæœåŠ¡', details: 'ç”Ÿæˆæ ‡å‡†åŒ–APIæ¥å£' },
                { step: 7, timestamp: '2024-12-12 14:18:48.901', node: 'blockchain', action: 'å­˜è¯ä¸Šé“¾', location: 'åŒºå—é“¾', details: 'æ•°æ®å“ˆå¸Œå­˜è¯ï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹' },
                { step: 8, timestamp: '2024-12-12 14:18:49.234', node: 'enterprise', action: 'æ•°æ®äº¤ä»˜', location: 'ä¼ä¸šå¹³å°', details: 'æ¨é€è‡³ä¼ä¸šç›‘ç®¡å¹³å°' }
            ]
        };

        // è½¦è¾†VINç å’Œä¼ä¸šä¿¡ç”¨ä»£ç æ˜ å°„å…³ç³»
        const vehicleEnterpriseMapping = {
            'LSGWB54E8KS123456': {
                creditCode: '91110000MA01234567',
                company: 'åŒ—äº¬ç†æƒ³æ±½è½¦æœ‰é™å…¬å¸',
                vehicleModel: 'ç†æƒ³L9',
                productionDate: '2023-08-15',
                registrationLocation: 'åŒ—äº¬å¸‚æœé˜³åŒº'
            },
            'LVGB34E2XMF123789': {
                creditCode: '91310000MA1FL23456',
                company: 'ä¸Šæµ·è”šæ¥æ±½è½¦æœ‰é™å…¬å¸',
                vehicleModel: 'ES8',
                productionDate: '2023-09-20',
                registrationLocation: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº'
            },
            'LBVCU31E8LF456123': {
                creditCode: '91440300MA5EQRJX8X',
                company: 'æ¯”äºšè¿ªæ±½è½¦å·¥ä¸šæœ‰é™å…¬å¸',
                vehicleModel: 'å”DM-i',
                productionDate: '2023-07-10',
                registrationLocation: 'æ·±åœ³å¸‚å—å±±åŒº'
            }
        };

        // ç”Ÿæˆæ–°æ•°æ®åŒ…ä¿¡æ¯
        function generateRandomPacketData() {
            const vins = Object.keys(vehicleEnterpriseMapping);
            const randomVin = vins[Math.floor(Math.random() * vins.length)];
            const vehicleInfo = vehicleEnterpriseMapping[randomVin];
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
            const packetId = `PKT-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
            
            const dataTypes = [
                'ä½ç½®è½¨è¿¹+é©¾é©¶è¡Œä¸º', 
                'è½¦è¾†çŠ¶æ€+ç¯å¢ƒæ„ŸçŸ¥', 
                'å……ç”µæ•°æ®+èƒ½è€—åˆ†æ', 
                'è¡Œé©¶è·¯å¾„+äº¤é€šçŠ¶å†µ',
                'è½¦è½½è¯Šæ–­+æ•…éšœé¢„è­¦'
            ];
            
            return {
                id: packetId,
                vin: randomVin,
                creditCode: vehicleInfo.creditCode,
                dataType: dataTypes[Math.floor(Math.random() * dataTypes.length)],
                collectTime: timestamp,
                dataSize: (Math.random() * 5 + 0.5).toFixed(2) + ' MB',
                vehicleModel: vehicleInfo.vehicleModel,
                manufacturer: vehicleInfo.company,
                location: {
                    lat: 39.9 + (Math.random() - 0.5) * 0.2,
                    lng: 116.4 + (Math.random() - 0.5) * 0.2,
                    address: vehicleInfo.registrationLocation
                }
            };
        }

        // æ›´æ–°æ•°æ®åŒ…æ˜¾ç¤ºä¿¡æ¯
        function updatePacketDisplay(packetData) {
            document.getElementById('packetId').textContent = packetData.id;
            document.getElementById('vinCode').textContent = packetData.vin;
            document.getElementById('creditCode').textContent = packetData.creditCode;
            document.getElementById('dataType').textContent = packetData.dataType;
            document.getElementById('collectTime').textContent = packetData.collectTime;
            document.getElementById('dataSize').textContent = packetData.dataSize;
            
            // æ›´æ–°æº¯æºçŠ¶æ€
            document.getElementById('traceStatus').textContent = `æ­£åœ¨è¿½è¸ªæ•°æ®åŒ… ${packetData.id} çš„ä¼ æ’­è·¯å¾„...`;
        }

        // åˆ›å»ºæ—¶é—´è½´è¿½è¸ªåºåˆ—
        function showTraceTimeline(packetData) {
            const timelineContainer = document.createElement('div');
            timelineContainer.className = 'trace-timeline';
            timelineContainer.innerHTML = `
                <div class="timeline-header">
                    <h3>ğŸ“‹ æ•°æ®åŒ…ä¼ æ’­è·¯å¾„æ—¶é—´è½´</h3>
                    <div class="timeline-info">
                        <span>æ•°æ®åŒ…ID: ${packetData.id}</span>
                        <span>è½¦è¾†: ${packetData.vehicleModel} (${packetData.vin})</span>
                    </div>
                </div>
                <div class="timeline-steps" id="timelineSteps"></div>
            `;
            
            // æ’å…¥åˆ°ä¸»å®¹å™¨
            const container = document.querySelector('.container');
            const existingTimeline = container.querySelector('.trace-timeline');
            if (existingTimeline) existingTimeline.remove();
            container.appendChild(timelineContainer);
            
            // åŠ¨æ€æ·»åŠ æ—¶é—´è½´æ­¥éª¤
            const stepsContainer = document.getElementById('timelineSteps');
            currentPacketData.traceSequence.forEach((step, index) => {
                setTimeout(() => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'timeline-step active';
                    stepElement.innerHTML = `
                        <div class="step-marker">${step.step}</div>
                        <div class="step-content">
                            <div class="step-title">${step.action} - ${step.location}</div>
                            <div class="step-time">${step.timestamp}</div>
                            <div class="step-details">${step.details}</div>
                        </div>
                    `;
                    stepsContainer.appendChild(stepElement);
                }, index * 400);
            });
        }
    </script>
</body>
</html>
